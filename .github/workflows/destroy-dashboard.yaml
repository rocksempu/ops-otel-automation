name: Decommission (Simples)

on:
  workflow_dispatch:
    inputs:
      service_name:
        description: 'Nome do Servi√ßo (Veja no T√≠tulo do Dashboard)'
        required: true
      
      action_type:
        type: choice
        description: 'O que voc√™ quer fazer?'
        options:
        - 'üîç APENAS SIMULAR (Dry Run)'
        - 'üí• DESTRUIR DE VERDADE (Execute)'
        default: 'üîç APENAS SIMULAR (Dry Run)'
        required: true

jobs:
  manage-lifecycle:
    runs-on: self-hosted
    name: "${{ inputs.action_type }}: ${{ inputs.service_name }}"
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # Instala√ß√£o do Requests usando o caminho completo do Python
      - name: Instalar Python Requests
        run: '& "C:\Users\FabioPaixao\AppData\Local\Programs\Python\Python313\python.exe" -m pip install requests'

      # PASSO 1: MODO SIMULA√á√ÉO (Dry Run)
      - name: Simular Limpeza (Dry Run)
        if: ${{ inputs.action_type == 'üîç APENAS SIMULAR (Dry Run)' }}
        env:
          GRAFANA_URL: ${{ secrets.GRAFANA_URL }}
          GRAFANA_TOKEN: ${{ secrets.GRAFANA_TOKEN }}
        run: |
          & "C:\Users\FabioPaixao\AppData\Local\Programs\Python\Python313\python.exe" scripts/clean_grafana.py "${{ inputs.service_name }}" --dry-run

      # PASSO 2: MODO DESTRUI√á√ÉO (Execute)
      - name: Executar Limpeza Real
        if: ${{ inputs.action_type == 'üí• DESTRUIR DE VERDADE (Execute)' }}
        env:
          GRAFANA_URL: ${{ secrets.GRAFANA_URL }}
          GRAFANA_TOKEN: ${{ secrets.GRAFANA_TOKEN }}
        run: |
          Write-Host "‚ö†Ô∏è INICIANDO PROCESSO DE DESTRUI√á√ÉO..."
          & "C:\Users\FabioPaixao\AppData\Local\Programs\Python\Python313\python.exe" scripts/clean_grafana.py "${{ inputs.service_name }}"