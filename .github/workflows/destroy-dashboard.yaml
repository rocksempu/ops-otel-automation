name: Decommission (Simples)

on:
  workflow_dispatch:
    inputs:
      # --- DADOS DE DISCOVERY ---
      service_name:
        description: 'Nome do Servi√ßo (Veja no T√≠tulo do Dashboard)'
        required: true
      
      environment:
        type: choice
        description: 'Ambiente'
        options: [dev, hml, prd]
        required: true

      # --- O BOT√ÉO DE SEGURAN√áA ---
      action_type:
        type: choice
        description: 'O que voc√™ quer fazer?'
        options:
        - 'üîç APENAS SIMULAR (Dry Run)'
        - 'üí• DESTRUIR DE VERDADE (Execute)'
        default: 'üîç APENAS SIMULAR (Dry Run)'
        required: true

      # --- GOVERNAN√áA (GMUD) ---
      change_ticket:
        description: 'N√∫mero da GMUD (Obrigat√≥rio para DESTRUIR em PRD)'
        required: false

jobs:
  manage-lifecycle:
    runs-on: self-hosted
    name: "${{ inputs.action_type }}: ${{ inputs.service_name }}"
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Instalar Python Requests
        run: '& "C:\Users\FabioPaixao\AppData\Local\Programs\Python\Python313\python.exe" -m pip install requests'

      # --- NOVO: SIMULA√á√ÉO DE GATE SERVICENOW (Para Decommission) ---
      - name: üëÆ ServiceNow Change Validation (GMUD)
        # Regra: S√≥ valida se for PRD E se for DESTRUIR DE VERDADE
        if: ${{ inputs.environment == 'prd' && inputs.action_type == 'üí• DESTRUIR DE VERDADE (Execute)' }}
        run: |
          $ticket = "${{ inputs.change_ticket }}"
          
          Write-Host "üîÑ Validando permiss√£o de destrui√ß√£o em PRD..."
          Start-Sleep -Seconds 1
          
          if ([string]::IsNullOrWhiteSpace($ticket)) {
            Write-Error "‚ùå ERRO DE GOVERNAN√áA: Para remover recursos de PRD, a GMUD √© obrigat√≥ria."
            exit 1
          }

          if (-not $ticket.StartsWith("CHG")) {
            Write-Error "‚ùå ERRO: Ticket inv√°lido. Formato esperado: CHGxxxxxx"
            exit 1
          }

          Write-Host "‚úÖ GMUD $ticket aprovada para execu√ß√£o de DECOMMISSION."

      # --- PASSOS ORIGINAIS ---
      - name: Simular Limpeza (Dry Run)
        if: ${{ inputs.action_type == 'üîç APENAS SIMULAR (Dry Run)' }}
        env:
          GRAFANA_URL: ${{ secrets.GRAFANA_URL }}
          GRAFANA_TOKEN: ${{ secrets.GRAFANA_TOKEN }}
        run: |
          & "C:\Users\FabioPaixao\AppData\Local\Programs\Python\Python313\python.exe" scripts/clean_grafana.py "${{ inputs.service_name }}" --dry-run

      - name: Executar Limpeza Real
        if: ${{ inputs.action_type == 'üí• DESTRUIR DE VERDADE (Execute)' }}
        env:
          GRAFANA_URL: ${{ secrets.GRAFANA_URL }}
          GRAFANA_TOKEN: ${{ secrets.GRAFANA_TOKEN }}
        run: |
          Write-Host "‚ö†Ô∏è INICIANDO PROCESSO DE DESTRUI√á√ÉO..."
          & "C:\Users\FabioPaixao\AppData\Local\Programs\Python\Python313\python.exe" scripts/clean_grafana.py "${{ inputs.service_name }}"