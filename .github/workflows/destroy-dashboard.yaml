name: Decommission (Simples)

on:
  workflow_dispatch:
    inputs:
      # --- DADOS DE DISCOVERY (O usu√°rio pega no Grafana) ---
      service_name:
        description: 'Nome do Servi√ßo (Veja no T√≠tulo do Dashboard)'
        required: true
      
      # --- O BOT√ÉO DE SEGURAN√áA ---
      action_type:
        type: choice
        description: 'O que voc√™ quer fazer?'
        options:
        - 'üîç APENAS SIMULAR (Dry Run)'
        - 'üí• DESTRUIR DE VERDADE (Execute)'
        default: 'üîç APENAS SIMULAR (Dry Run)'
        required: true

jobs:
  manage-lifecycle:
    runs-on: self-hosted
    name: "${{ inputs.action_type }}: ${{ inputs.service_name }}"
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Instalar Python Requests
        run: pip install requests

      # PASSO 1: MODO SIMULA√á√ÉO (Dry Run)
      # Mostra o que seria apagado, mas n√£o apaga.
      - name: Simular Limpeza (Dry Run)
        if: ${{ inputs.action_type == 'üîç APENAS SIMULAR (Dry Run)' }}
        env:
          GRAFANA_URL: ${{ secrets.GRAFANA_URL }}
          GRAFANA_TOKEN: ${{ secrets.GRAFANA_TOKEN }}
        run: |
          python scripts/clean_grafana.py "${{ inputs.service_name }}" --dry-run

      # PASSO 2: MODO DESTRUI√á√ÉO (Execute)
      # Apaga de verdade.
      - name: Executar Limpeza Real
        if: ${{ inputs.action_type == 'üí• DESTRUIR DE VERDADE (Execute)' }}
        env:
          GRAFANA_URL: ${{ secrets.GRAFANA_URL }}
          GRAFANA_TOKEN: ${{ secrets.GRAFANA_TOKEN }}
        run: |
          Write-Host "‚ö†Ô∏è INICIANDO PROCESSO DE DESTRUI√á√ÉO..."
          python scripts/clean_grafana.py "${{ inputs.service_name }}"