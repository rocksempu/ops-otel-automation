name: Decommission (Simples)

on:
  workflow_dispatch:
    inputs:
      # --- DADOS DE DISCOVERY (O usu√°rio pega no Grafana) ---
      service_name:
        description: 'Nome do Servi√ßo (Veja no T√≠tulo do Dashboard)'
        required: true
      service_namespace:
        description: 'Namespace (Veja nas Tags)'
        required: true
      service_owner:
        description: 'Owner (Veja nas Tags)'
        required: true
      environment:
        type: choice
        description: 'Ambiente'
        options: [dev, hml, prd]
        required: true
      
      # --- O BOT√ÉO DE SEGURAN√áA ---
      action_type:
        type: choice
        description: 'O que voc√™ quer fazer?'
        options:
        - 'üîç APENAS SIMULAR (Terraform Plan)'
        - 'üí• DESTRUIR DE VERDADE (Terraform Destroy)'
        default: 'üîç APENAS SIMULAR (Terraform Plan)'
        required: true

jobs:
  manage-lifecycle:
    runs-on: self-hosted
    name: "${{ inputs.action_type }}: ${{ inputs.service_name }}"
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Terraform Init
        working-directory: ./terraform
        run: '& "C:\Terraform\terraform.exe" init'

      # PASSO 1: SEMPRE MOSTRA O PLANO (Para o usu√°rio conferir)
      - name: Mostrar o que ser√° feito (Plan)
        working-directory: ./terraform
        env:
          TF_VAR_grafana_url: ${{ secrets.GRAFANA_URL }}
          TF_VAR_grafana_auth: ${{ secrets.GRAFANA_TOKEN }}
        run: |
          & "C:\Terraform\terraform.exe" plan -destroy `
            -var="template_type=goldensignals" `
            -var="service_name=${{ inputs.service_name }}" `
            -var="service_namespace=${{ inputs.service_namespace }}" `
            -var="service_owner=${{ inputs.service_owner }}" `
            -var="service_version=0.0.0" `
            -var="environment=${{ inputs.environment }}" `
            -var="enable_alerts=true"

      # PASSO 2: S√ì DESTROI SE O USU√ÅRIO ESCOLHEU A OP√á√ÉO DE DESTRUIR
      - name: Executar Destrui√ß√£o (Destroy)
        # Essa √© a trava l√≥gica simples que voc√™ pediu
        if: ${{ inputs.action_type == 'üí• DESTRUIR DE VERDADE (Terraform Destroy)' }}
        working-directory: ./terraform
        env:
          TF_VAR_grafana_url: ${{ secrets.GRAFANA_URL }}
          TF_VAR_grafana_auth: ${{ secrets.GRAFANA_TOKEN }}
        run: |
          Write-Host "INICIANDO DESTRUI√á√ÉO DOS RECURSOS..."
          & "C:\Terraform\terraform.exe" destroy -auto-approve `
            -var="template_type=goldensignals" `
            -var="service_name=${{ inputs.service_name }}" `
            -var="service_namespace=${{ inputs.service_namespace }}" `
            -var="service_owner=${{ inputs.service_owner }}" `
            -var="service_version=0.0.0" `
            -var="environment=${{ inputs.environment }}" `
            -var="enable_alerts=true"