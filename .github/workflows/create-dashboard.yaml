name: Criar Dashboard (Self-Service)

on:
  workflow_dispatch:
    inputs:
      template_type:
        type: choice
        description: 'Modelo de Dashboard'
        options:
        - goldensignals
        - detalhesporservico
        - rum
        required: true
      
      # Inputs de Governança Obrigatória (Conforme MVP)
      service_name:
        description: 'Nome do Serviço (Ex: ibpf-api)'
        required: true
      service_namespace:
        description: 'Namespace (Ex: pix, crm)'
        required: true
      service_owner:
        description: 'Owner (Squad/Email)'
        required: true
      environment:
        type: choice
        description: 'Ambiente'
        options: [dev, hml, prd]
        required: true
      service_version:
        description: 'Versão (SemVer)'
        default: '1.0.0'
        required: false

jobs:
  deploy-dashboard:
    runs-on: self-hosted
    name: "Criar: ${{ inputs.template_type }} para ${{ inputs.service_name }}"
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # Setup removido para usar instalação manual local e evitar erro de wrapper

      - name: Terraform Init
        working-directory: ./terraform
        # O & comercial é obrigatório no PowerShell para rodar executáveis com caminho entre aspas
        run: '& "C:\Terraform\terraform.exe" init'

      - name: Terraform Apply
        working-directory: ./terraform
        env:
          TF_VAR_grafana_url: ${{ secrets.GRAFANA_URL }}
          TF_VAR_grafana_auth: ${{ secrets.GRAFANA_TOKEN }}
        # Nota: No PowerShell, a quebra de linha é feita com CRASE (`), não barra invertida (\)
        run: |
          & "C:\Terraform\terraform.exe" apply -auto-approve `
            -var="template_type=${{ inputs.template_type }}" `
            -var="service_name=${{ inputs.service_name }}" `
            -var="service_namespace=${{ inputs.service_namespace }}" `
            -var="service_owner=${{ inputs.service_owner }}" `
            -var="service_version=${{ inputs.service_version }}" `
            -var="environment=${{ inputs.environment }}"