name: Criar Dashboard (Self-Service)

on:
  workflow_dispatch:
    inputs:
      # --- NOVO: SELE√á√ÉO DE A√á√ÉO (Manual Approve) ---
      action_type:
        type: choice
        description: 'O que voc√™ quer fazer?'
        options:
        - 'üîç SIMULAR (Terraform Plan)'
        - 'üöÄ CRIAR DE VERDADE (Terraform Apply)'
        default: 'üîç SIMULAR (Terraform Plan)'
        required: true

      template_type:
        type: choice
        description: 'Modelo de Dashboard'
        options:
        - goldensignals
        - detalhesporservico
        - rum
        required: true
      
      # Inputs de Governan√ßa Obrigat√≥ria
      service_name:
        description: 'Nome do Servi√ßo (Ex: ibpf-api)'
        required: true
      service_namespace:
        description: 'Namespace (Ex: pix, crm)'
        required: true
      service_owner:
        description: 'Owner (Squad/Email)'
        required: true
      environment:
        type: choice
        description: 'Ambiente'
        options: [dev, hml, prd]
        required: true
      service_version:
        description: 'Vers√£o (SemVer)'
        default: '1.0.0'
        required: false
      
      # Controle de Alertas
      enable_alerts:
        description: 'Ativar Alertas? (Em PRD ser√° sempre Ativado)'
        type: boolean
        required: false
        default: true

jobs:
  deploy-dashboard:
    runs-on: self-hosted
    name: "${{ inputs.action_type }}: ${{ inputs.service_name }}"
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # --- 1. QUALITY GATE (Mantido do seu original) ---
      - name: üõ°Ô∏è Quality Gate - Validar JSONs
        run: |
          $pythonPath = "C:\Users\FabioPaixao\AppData\Local\Programs\Python\Python313\python.exe"
          $files = Get-ChildItem "templates\*.json"
          
          foreach ($file in $files) {
            Write-Host "Validando: $($file.Name)..."
            & $pythonPath -m json.tool "$($file.FullName)" > $null
            
            if ($LASTEXITCODE -ne 0) {
              Write-Error "‚ùå JSON Inv√°lido: $($file.Name)"
              exit 1
            }
          }
          Write-Host "‚úÖ Todos os templates est√£o v√°lidos!"

      # --- 2. TERRAFORM INIT (Sempre roda) ---
      - name: Terraform Init
        working-directory: ./terraform
        run: '& "C:\Terraform\terraform.exe" init'

      # --- 3. PLAN (Roda apenas se escolheu SIMULAR) ---
      - name: Terraform Plan (Simula√ß√£o)
        if: ${{ inputs.action_type == 'üîç SIMULAR (Terraform Plan)' }}
        working-directory: ./terraform
        env:
          TF_VAR_grafana_url: ${{ secrets.GRAFANA_URL }}
          TF_VAR_grafana_auth: ${{ secrets.GRAFANA_TOKEN }}
        run: |
          Write-Host "üîç EXECUTANDO SIMULA√á√ÉO (PLAN)... NADA SER√Å CRIADO."
          & "C:\Terraform\terraform.exe" plan `
            -var="template_type=${{ inputs.template_type }}" `
            -var="service_name=${{ inputs.service_name }}" `
            -var="service_namespace=${{ inputs.service_namespace }}" `
            -var="service_owner=${{ inputs.service_owner }}" `
            -var="service_version=${{ inputs.service_version }}" `
            -var="environment=${{ inputs.environment }}" `
            -var="enable_alerts=${{ inputs.enable_alerts }}"

      # --- 4. APPLY (Roda apenas se escolheu CRIAR) ---
      - name: Terraform Apply (Execu√ß√£o Real)
        if: ${{ inputs.action_type == 'üöÄ CRIAR DE VERDADE (Terraform Apply)' }}
        working-directory: ./terraform
        env:
          TF_VAR_grafana_url: ${{ secrets.GRAFANA_URL }}
          TF_VAR_grafana_auth: ${{ secrets.GRAFANA_TOKEN }}
        run: |
          Write-Host "üöÄ APLICANDO MUDAN√áAS NO GRAFANA..."
          & "C:\Terraform\terraform.exe" apply -auto-approve `
            -var="template_type=${{ inputs.template_type }}" `
            -var="service_name=${{ inputs.service_name }}" `
            -var="service_namespace=${{ inputs.service_namespace }}" `
            -var="service_owner=${{ inputs.service_owner }}" `
            -var="service_version=${{ inputs.service_version }}" `
            -var="environment=${{ inputs.environment }}" `
            -var="enable_alerts=${{ inputs.enable_alerts }}"