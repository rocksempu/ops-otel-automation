name: Criar Dashboard (Self-Service)

on:
  workflow_dispatch:
    inputs:
      # --- SELE√á√ÉO DE A√á√ÉO ---
      action_type:
        type: choice
        description: 'O que voc√™ quer fazer?'
        options:
        - 'üîç SIMULAR (Terraform Plan)'
        - 'üöÄ CRIAR DE VERDADE (Terraform Apply)'
        default: 'üîç SIMULAR (Terraform Plan)'
        required: true

      template_type:
        type: choice
        description: 'Modelo de Dashboard'
        options:
        - goldensignals
        - detalhesporservico
        - rum
        required: true
      
      # --- DADOS DO SERVI√áO ---
      service_name:
        description: 'Nome do Servi√ßo (Ex: ibpf-api)'
        required: true
      service_namespace:
        description: 'Namespace (Ex: pix, crm)'
        required: true
      service_owner:
        description: 'Owner (Squad/Email)'
        required: true
      environment:
        type: choice
        description: 'Ambiente'
        options: [dev, hml, prd]
        required: true
      service_version:
        description: 'Vers√£o (SemVer)'
        default: '1.0.0'
        required: false
      
      # --- GOVERNAN√áA (GMUD) ---
      change_ticket:
        description: 'N√∫mero da GMUD (Obrigat√≥rio para PRD - Ex: CHG00123)'
        required: false 
      
      enable_alerts:
        description: 'Ativar Alertas? (Em PRD ser√° sempre Ativado)'
        type: boolean
        required: false
        default: true

jobs:
  deploy-dashboard:
    runs-on: self-hosted
    name: "${{ inputs.action_type }}: ${{ inputs.service_name }}"
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # --- NOVO: SIMULA√á√ÉO DE GATE SERVICENOW (A Teatralidade) ---
      - name: üëÆ ServiceNow Change Validation (GMUD)
        # Regra: S√≥ valida se for PRD
        if: ${{ inputs.environment == 'prd' }}
        run: |
          $ticket = "${{ inputs.change_ticket }}"
          
          Write-Host "üîÑ Conectando API ServiceNow (Mock)..."
          Start-Sleep -Seconds 2
          
          # Valida√ß√£o 1: Campo Vazio
          if ([string]::IsNullOrWhiteSpace($ticket)) {
            Write-Error "‚ùå ERRO DE GOVERNAN√áA: Para deploy em PRD, o n√∫mero da GMUD √© obrigat√≥rio."
            exit 1
          }

          # Valida√ß√£o 2: Formato (Simula√ß√£o)
          if (-not $ticket.StartsWith("CHG")) {
            Write-Error "‚ùå ERRO: O ticket '$ticket' n√£o √© v√°lido. Formato esperado: CHGxxxxxx"
            exit 1
          }

          Write-Host "üîé Buscando status do ticket: $ticket..."
          Start-Sleep -Seconds 2
          
          Write-Host "‚úÖ Ticket Encontrado."
          Write-Host "üìã Status: IMPLEMENTATION (Scheduled)"
          Write-Host "üìÖ Janela de Mudan√ßa: V√ÅLIDA"
          Write-Host "‚úÖ APROVADO para execu√ß√£o."

      # --- QUALITY GATE (Mantido) ---
      - name: üõ°Ô∏è Quality Gate - Validar JSONs
        run: |
          $pythonPath = "C:\Users\FabioPaixao\AppData\Local\Programs\Python\Python313\python.exe"
          $files = Get-ChildItem "templates\*.json"
          foreach ($file in $files) {
            Write-Host "Validando: $($file.Name)..."
            & $pythonPath -m json.tool "$($file.FullName)" > $null
            if ($LASTEXITCODE -ne 0) { Write-Error "‚ùå JSON Inv√°lido: $($file.Name)"; exit 1 }
          }
          Write-Host "‚úÖ Todos os templates est√£o v√°lidos!"

      # --- TERRAFORM ---
      - name: Terraform Init
        working-directory: ./terraform
        run: '& "C:\Terraform\terraform.exe" init'

      - name: Terraform Plan (Simula√ß√£o)
        if: ${{ inputs.action_type == 'üîç SIMULAR (Terraform Plan)' }}
        working-directory: ./terraform
        env:
          TF_VAR_grafana_url: ${{ secrets.GRAFANA_URL }}
          TF_VAR_grafana_auth: ${{ secrets.GRAFANA_TOKEN }}
        run: |
          Write-Host "üîç EXECUTANDO SIMULA√á√ÉO (PLAN)..."
          & "C:\Terraform\terraform.exe" plan `
            -var="template_type=${{ inputs.template_type }}" `
            -var="service_name=${{ inputs.service_name }}" `
            -var="service_namespace=${{ inputs.service_namespace }}" `
            -var="service_owner=${{ inputs.service_owner }}" `
            -var="service_version=${{ inputs.service_version }}" `
            -var="environment=${{ inputs.environment }}" `
            -var="enable_alerts=${{ inputs.enable_alerts }}"

      - name: Terraform Apply (Execu√ß√£o Real)
        if: ${{ inputs.action_type == 'üöÄ CRIAR DE VERDADE (Terraform Apply)' }}
        working-directory: ./terraform
        env:
          TF_VAR_grafana_url: ${{ secrets.GRAFANA_URL }}
          TF_VAR_grafana_auth: ${{ secrets.GRAFANA_TOKEN }}
        run: |
          Write-Host "üöÄ APLICANDO MUDAN√áAS..."
          & "C:\Terraform\terraform.exe" apply -auto-approve `
            -var="template_type=${{ inputs.template_type }}" `
            -var="service_name=${{ inputs.service_name }}" `
            -var="service_namespace=${{ inputs.service_namespace }}" `
            -var="service_owner=${{ inputs.service_owner }}" `
            -var="service_version=${{ inputs.service_version }}" `
            -var="environment=${{ inputs.environment }}" `
            -var="enable_alerts=${{ inputs.enable_alerts }}"