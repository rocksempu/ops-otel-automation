name: Criar Dashboard (Self-Service)

on:
  workflow_dispatch:
    inputs:
      # --- SELEÇÃO DE AÇÃO ---
      action_type:
        type: choice
        description: 'O que voce quer fazer?'
        options:
        - 'SIMULAR (Terraform Plan)'
        - 'CRIAR DE VERDADE (Terraform Apply)'
        default: 'SIMULAR (Terraform Plan)'
        required: true

      template_type:
        type: choice
        description: 'Modelo de Dashboard'
        options:
        - goldensignals
        - detalhesporservico
        - rum
        required: true
      
      # --- DADOS DO SERVIÇO ---
      service_name:
        description: 'Nome do Servico (Ex: ibpf-api)'
        required: true
      service_namespace:
        description: 'Namespace (Ex: pix, crm)'
        required: true
      service_owner:
        description: 'Owner (Squad/Email)'
        required: true
      environment:
        type: choice
        description: 'Ambiente'
        options: [dev, hml, prd]
        required: true
      service_version:
        description: 'Versao (SemVer)'
        default: '1.0.0'
        required: false
      
      # --- GOVERNANÇA (GMUD) ---
      change_ticket:
        description: 'Numero da GMUD (Obrigatorio para PRD - Ex: CHG00123)'
        required: false 
      
      enable_alerts:
        description: 'Ativar Alertas? (Em PRD sera sempre Ativado)'
        type: boolean
        required: false
        default: true

jobs:
  deploy-dashboard:
    runs-on: self-hosted
    name: "${{ inputs.action_type }}: ${{ inputs.service_name }}"
    
    # Gate de Ambiente (Opcional - se nao usar, pode remover esta linha)
    # environment: ${{ inputs.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # --- PASSO DE VALIDAÇÃO SERVICENOW (Corrigido) ---
      - name: ServiceNow Change Validation (GMUD)
        # Regra: Só valida se for PRD
        if: ${{ inputs.environment == 'prd' }}
        run: |
          $ticket = "${{ inputs.change_ticket }}"
          
          Write-Host "[INFO] Conectando API ServiceNow (Mock)..."
          Start-Sleep -Seconds 2
          
          # Validação 1: Campo Vazio
          if ([string]::IsNullOrWhiteSpace($ticket)) {
            Write-Error "[ERRO] GOVERNANCA: Para deploy em PRD, o numero da GMUD e obrigatorio."
            exit 1
          }

          # Validação 2: Formato (Simulação)
          if (-not $ticket.StartsWith("CHG")) {
            Write-Error "[ERRO] O ticket '$ticket' nao e valido. Formato esperado: CHGxxxxxx"
            exit 1
          }

          Write-Host "[INFO] Buscando status do ticket: $ticket..."
          Start-Sleep -Seconds 2
          
          Write-Host "[OK] Ticket Encontrado."
          Write-Host "[INFO] Status: IMPLEMENTATION (Scheduled)"
          Write-Host "[INFO] Janela de Mudanca: VALIDA"
          Write-Host "[OK] APROVADO para execucao."

      # --- QUALITY GATE (Focado no Template Escolhido) ---
      - name: Quality Gate - Validar JSON (Selecionado)
        run: |
          $pythonPath = "C:\Users\FabioPaixao\AppData\Local\Programs\Python\Python313\python.exe"
          
          # Pega o nome do template escolhido no dropdown
          $selectedTemplate = "${{ inputs.template_type }}"
          $targetFile = "templates\$selectedTemplate.json"
          
          Write-Host "Validando apenas o template escolhido: $targetFile..."
          
          # Verifica se o arquivo existe
          if (-not (Test-Path $targetFile)) {
            Write-Error "[ERRO] Arquivo de template nao encontrado: $targetFile"
            exit 1
          }

          # Valida apenas ele
          & $pythonPath -m json.tool "$targetFile" > $null
          
          if ($LASTEXITCODE -ne 0) { 
            Write-Error "[ERRO] O JSON do template '$selectedTemplate' esta invalido. Corrija antes de prosseguir."
            exit 1 
          }
          
          Write-Host "[OK] O template '$selectedTemplate' esta valido e seguro para deploy."

      # --- TERRAFORM ---
      - name: Terraform Init
        working-directory: ./terraform
        run: '& "C:\Terraform\terraform.exe" init'

      - name: Terraform Plan (Simulacao)
        if: ${{ inputs.action_type == 'SIMULAR (Terraform Plan)' }}
        working-directory: ./terraform
        env:
          TF_VAR_grafana_url: ${{ secrets.GRAFANA_URL }}
          TF_VAR_grafana_auth: ${{ secrets.GRAFANA_TOKEN }}
        run: |
          Write-Host "[INFO] EXECUTANDO SIMULACAO (PLAN)..."
          & "C:\Terraform\terraform.exe" plan `
            -var="template_type=${{ inputs.template_type }}" `
            -var="service_name=${{ inputs.service_name }}" `
            -var="service_namespace=${{ inputs.service_namespace }}" `
            -var="service_owner=${{ inputs.service_owner }}" `
            -var="service_version=${{ inputs.service_version }}" `
            -var="environment=${{ inputs.environment }}" `
            -var="enable_alerts=${{ inputs.enable_alerts }}"

      - name: Terraform Apply (Execucao Real)
        if: ${{ inputs.action_type == 'CRIAR DE VERDADE (Terraform Apply)' }}
        working-directory: ./terraform
        env:
          TF_VAR_grafana_url: ${{ secrets.GRAFANA_URL }}
          TF_VAR_grafana_auth: ${{ secrets.GRAFANA_TOKEN }}
        run: |
          Write-Host "[INFO] APLICANDO MUDANCAS..."
          & "C:\Terraform\terraform.exe" apply -auto-approve `
            -var="template_type=${{ inputs.template_type }}" `
            -var="service_name=${{ inputs.service_name }}" `
            -var="service_namespace=${{ inputs.service_namespace }}" `
            -var="service_owner=${{ inputs.service_owner }}" `
            -var="service_version=${{ inputs.service_version }}" `
            -var="environment=${{ inputs.environment }}" `
            -var="enable_alerts=${{ inputs.enable_alerts }}"